<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="A simple and beautiful notes application"
        />
        <title>Simple Notes</title>
        <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
        <script>
            if (typeof hljs === "undefined") {
                window.hljs = {
                    highlightElement: function () {},
                    getLanguage: function () {
                        return false;
                    },
                    highlight: function (code) {
                        return { value: code };
                    },
                };
                console.warn("Highlight.js not loaded, using fallback");
            }
        </script>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <main>
            <section id="note-form">
                <input
                    type="text"
                    id="note-title"
                    placeholder="Title"
                    aria-label="Note title"
                    maxlength="60"
                    title="Maximum title length is 60 characters"
                />
                <span class="char-count" id="note-title-charcount"></span>
                <textarea
                    id="note-body"
                    placeholder="Take a note..."
                    aria-label="Note content"
                ></textarea>
                <div class="editor-toolbar">
                    <button
                        id="add-task-btn"
                        class="toolbar-btn"
                        title="Add task checkbox"
                    >
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="3"
                                y="3"
                                width="18"
                                height="18"
                                rx="2"
                                ry="2"
                            ></rect>
                            <path d="M9 12l2 2 4-4"></path>
                        </svg>
                        Add task
                    </button>
                </div>
                <div class="form-actions">
                    <div
                        class="color-options"
                        aria-label="Note color options"
                    ></div>
                    <button id="add-note" aria-label="Add note">Done</button>
                </div>
            </section>
            <section id="notes-list" aria-label="Your notes"></section>
        </main>

        <div
            id="edit-modal"
            class="modal"
            role="dialog"
            aria-labelledby="edit-modal-title"
        >
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="edit-modal-title">Edit Note</h3>
                    <button
                        class="close-modal"
                        aria-label="Close modal"
                        title="Close"
                    >
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <input
                        type="text"
                        id="edit-title"
                        placeholder="Title"
                        aria-label="Edit note title"
                        maxlength="80"
                        title="Maximum title length is 80 characters"
                    />
                    <span class="char-count" id="edit-title-charcount"></span>
                    <textarea
                        id="edit-body"
                        placeholder="Note content..."
                        aria-label="Edit note content"
                    ></textarea>
                    <div class="editor-toolbar">
                        <button
                            id="add-checkbox-btn"
                            class="toolbar-btn"
                            type="button"
                            onclick="insertTaskTemplate(document.getElementById('edit-body'))"
                            title="Add task checkbox"
                        >
                            <svg
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <path d="M9 12l2 2 4-4"></path>
                            </svg>
                            Add task
                        </button>
                    </div>
                    <div class="form-actions">
                        <div
                            class="color-options edit-color-options"
                            aria-label="Note color options"
                        ></div>
                        <button id="save-edit" aria-label="Save changes">
                            Save
                        </button>
                    </div>
                    <input type="hidden" id="edit-note-id" />
                </div>
            </div>
        </div>

        <div
            id="delete-modal"
            class="modal"
            role="dialog"
            aria-labelledby="delete-modal-title"
        >
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="delete-modal-title">Delete Note</h3>
                    <button
                        class="close-modal"
                        aria-label="Close modal"
                        title="Close"
                    >
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        Are you sure you want to delete this note? This action
                        cannot be undone.
                    </p>
                    <div class="modal-actions">
                        <button
                            class="cancel-delete"
                            aria-label="Cancel deletion"
                        >
                            Cancel
                        </button>
                        <button
                            class="confirm-delete"
                            aria-label="Confirm deletion"
                        >
                            Delete
                        </button>
                    </div>
                    <input type="hidden" id="delete-note-id" />
                </div>
            </div>
        </div>

        <div id="modal-backdrop" aria-hidden="true"></div>

        <script>
            window.marked = window.marked || {
                parse: function (text) {
                    return text;
                },
                setOptions: function () {},
            };

            try {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    highlight: function (code, lang) {
                        if (typeof hljs !== "undefined" && hljs.getLanguage) {
                            const language = hljs.getLanguage(lang)
                                ? lang
                                : "plaintext";
                            return hljs.highlight(code, { language }).value;
                        }
                        return code;
                    },
                });
                console.log("Markdown parser initialized");
            } catch (err) {
                console.warn("Error initializing Markdown parser:", err);
            }
        </script>

        <script src="masonry.js"></script>
        <script src="script.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                console.log("Document ready, waiting for fonts to load...");

                if (!window.noteMasonry) {
                    console.log("noteMasonry not initialized yet, waiting...");
                }

                document.fonts.ready.then(() => {
                    console.log("Fonts loaded");

                    setTimeout(() => {
                        if (window.noteMasonry) {
                            console.log("Refreshing masonry layout");
                            window.noteMasonry.refresh();
                        } else {
                            console.warn("noteMasonry still not available");
                            if (typeof NoteMasonry === "function") {
                                console.log("Creating noteMasonry instance");
                                const computedStyle = getComputedStyle(
                                    document.documentElement
                                );
                                const spacingMd =
                                    parseFloat(
                                        computedStyle.getPropertyValue(
                                            "--spacing-md"
                                        ) || "1rem"
                                    ) * 16;

                                window.noteMasonry = new NoteMasonry(
                                    "#notes-list",
                                    {
                                        minColumnWidth:
                                            window.innerWidth < 640 ? 160 : 220,
                                        maxColumns: 5,
                                        gutter: spacingMd,
                                        animated: true,
                                    }
                                );
                            }
                        }
                    }, 300);
                });
            });

            window.addEventListener("load", function () {
                console.log("Window loaded, refreshing layout");
                setTimeout(() => {
                    if (window.noteMasonry) {
                        window.noteMasonry.refresh();
                    } else if (typeof NoteMasonry === "function") {
                        const computedStyle = getComputedStyle(
                            document.documentElement
                        );
                        const spacingMd =
                            parseFloat(
                                computedStyle.getPropertyValue(
                                    "--spacing-md"
                                ) || "1rem"
                            ) * 16;

                        window.noteMasonry = new NoteMasonry("#notes-list", {
                            minColumnWidth: window.innerWidth < 640 ? 160 : 220,
                            maxColumns: 5,
                            gutter: spacingMd,
                            animated: true,
                        });
                    }
                }, 200);
            });
        </script>
    </body>
</html>
